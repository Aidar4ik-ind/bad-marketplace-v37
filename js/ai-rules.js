// Расширенные правила для ИИ-ассистента
const aiRulesExtended = {
    // Сон
    'сон': [1, 2, 26, 27, 30],
    'спать': [1, 2, 26, 27, 30],
    'бессонница': [1, 2, 27, 30],
    'проблемы со сном': [1, 2, 26, 27, 30],
    'просыпаюсь': [1, 2, 30],
    'ночью не сплю': [1, 2, 26, 27],
    'засыпаю': [1, 2, 26],
    'качество сна': [2, 30],
    'глубокий сон': [2, 30],
    'отдых': [1, 2, 6, 25],
    'ночной': [2, 26, 27, 30],
    'пробуждение': [2, 30],
    'циркадный': [2, 30],
    'режим сна': [2, 30],
    'дремота': [2, 26],
    
    // Стресс и нервы
    'стресс': [1, 6, 7, 25, 28, 29],
    'нервы': [1, 6, 7, 25, 28],
    'тревож': [6, 7, 25],
    'волнение': [6, 7, 25],
    'спокойствие': [6, 7, 25],
    'переживания': [6, 7, 25],
    'паника': [6, 7],
    'нервный': [1, 6, 7, 25],
    'успоко': [6, 7, 25, 26],
    'расслаб': [6, 7, 25, 26],
    'тревога': [6, 7, 25],
    'напряжение': [1, 6, 7, 29],
    'раздражительность': [6, 7, 25],
    'нервное напряжение': [1, 6, 7, 29],
    'эмоциональное выгорание': [6, 25, 28],
    'психическое напряжение': [6, 7, 25],
    
    // Энергия и усталость
    'усталость': [3, 8, 9, 10, 24],
    'энергия': [3, 8, 9, 10, 24],
    'силы': [3, 9, 10, 24],
    'вялость': [3, 10, 24],
    'слабость': [3, 10, 24],
    'бодрость': [3, 9, 10, 24],
    'утомление': [3, 10, 24],
    'разбитость': [3, 8, 10],
    'активность': [3, 9, 24],
    'хроническая усталость': [3, 8, 10, 24],
    'нет сил': [3, 9, 10],
    'выносливость': [3, 9, 24],
    'жизненный тонус': [3, 9, 10],
    'энергетический уровень': [3, 8, 9],
    'физическая усталость': [3, 8, 10],
    'умственная усталость': [7, 24],
    
    // Иммунитет
    'иммунитет': [4, 11, 12, 13, 21],
    'простуда': [4, 11, 12, 21],
    'болезнь': [4, 11, 12, 21],
    'грипп': [4, 11, 12],
    'здоровье': [4, 11, 12, 13, 21],
    'аллергия': [13],
    'сезон': [4, 11, 12, 21],
    'вирус': [4, 11, 12, 21],
    'защита': [4, 12, 21],
    'сопротивление': [4, 12, 21],
    'иммунная система': [4, 11, 12, 13],
    'часто болею': [4, 11, 12, 21],
    'ослабленный иммунитет': [4, 12, 13, 21],
    'профилактика простуды': [4, 11, 12],
    'респираторные инфекции': [4, 11, 12],
    'восстановление после болезни': [4, 11, 12, 13],
    
    // Пищеварение и детокс
    'пищеварение': [5, 17, 18, 23],
    'желудок': [17, 18, 23],
    'детокс': [5, 22],
    'очищение': [5, 22],
    'печень': [5, 22],
    'токсины': [5, 22],
    'запор': [17],
    'диарея': [18],
    'изжога': [18],
    'вздутие': [17, 18, 23],
    'тошнота': [18, 23],
    'тяжесть': [17, 18],
    'очистить организм': [5, 22],
    'шлаки': [5, 22],
    'микрофлора': [13, 17],
    'кишечник': [13, 17, 18],
    'пищеварительная система': [17, 18, 23],
    'нарушение пищеварения': [17, 18],
    'гастрит': [17, 18],
    'желудочно-кишечный тракт': [17, 18, 23],
    
    // Суставы
    'суставы': [14, 15, 16, 19, 20],
    'колени': [14, 19, 20],
    'спина': [14, 15, 20],
    'артрит': [14, 19, 20],
    'хруст': [14, 15, 20],
    'гибкость': [14, 15, 20],
    'подвижность': [14, 15, 20],
    'боль в суставах': [14, 19, 20],
    'кост': [14, 15, 20],
    'хрящ': [14, 15, 20],
    'опорно-двигательный': [14, 15, 20],
    'ревматизм': [14, 19],
    'остеоартрит': [14, 19, 20],
    'скованность': [14, 15, 20],
    'суставная боль': [14, 19, 20],
    'воспаление суставов': [14, 19],
    'суставная подвижность': [14, 15, 20],
    
    // Мозг и концентрация
    'концентрация': [7, 24],
    'память': [24],
    'мозг': [7, 24],
    'фокус': [7, 24],
    'внимание': [7, 24],
    'учёба': [7, 24],
    'работа': [7, 24],
    'экзамен': [7, 24],
    'мышление': [7, 24],
    'ясность': [7, 24],
    'когнитивные функции': [7, 24],
    'умственная работоспособность': [7, 24],
    'сосредоточенность': [7, 24],
    'мозговая активность': [7, 24],
    'ментальная ясность': [7, 24],
    'работоспособность мозга': [7, 24],
    'интеллектуальная деятельность': [7, 24],
    
    // Настроение
    'настроение': [1, 6, 25],
    'депрессия': [25],
    'апатия': [25],
    'грусть': [25],
    'подавлен': [25],
    'эмоции': [6, 25],
    'равновесие': [6, 25],
    'эмоциональное состояние': [6, 25],
    'психическое здоровье': [6, 25],
    'психологическое благополучие': [6, 25],
    'эмоциональная стабильность': [6, 25],
    'позитивное настроение': [6, 25],
    'депрессивное состояние': [25],
    'эмоциональный фон': [6, 25],
    
    // Общие слова
    'здоров': [4, 11, 12, 17, 18],
    'поддержка': [1, 4, 11, 12, 14, 17],
    'помощь': [1, 4, 11, 14, 17, 25],
    'нехватка': [1, 10, 11, 12],
    'дефицит': [1, 10, 11, 12],
    'баланс': [1, 6, 25],
    'восстановление': [1, 5, 14, 15, 17],
    'профилактика': [4, 11, 12, 14, 17],
    'общее состояние': [1, 4, 10, 11],
    'самочувствие': [1, 4, 6, 11],
    'организм': [1, 4, 5, 11, 17],
    'функционирование': [1, 4, 17, 24]
};

// Функция для анализа запроса
function analyzeHealthRequest(text) {
    const textLower = text.toLowerCase();
    const foundKeywords = [];
    const recommendedIds = new Set();
    
    // Ищем ключевые слова
    Object.keys(aiRulesExtended).forEach(keyword => {
        if (textLower.includes(keyword)) {
            foundKeywords.push(keyword);
            aiRulesExtended[keyword].forEach(id => recommendedIds.add(id));
        }
    });
    
    // Если найдено мало ключевых слов, пробуем искать по частям
    if (foundKeywords.length === 0) {
        const words = textLower.split(/\s+/);
        words.forEach(word => {
            if (word.length > 3) {
                Object.keys(aiRulesExtended).forEach(keyword => {
                    if (keyword.includes(word) || word.includes(keyword)) {
                        foundKeywords.push(keyword);
                        aiRulesExtended[keyword].forEach(id => recommendedIds.add(id));
                    }
                });
            }
        });
    }
    
    return {
        keywords: [...new Set(foundKeywords)], // Уникальные ключевые слова
        productIds: [...recommendedIds],
        confidence: foundKeywords.length > 0 ? 'high' : 'low'
    };
}

// Генерация ответа ИИ
function generateAIResponse(analysis) {
    const { keywords, productIds, confidence } = analysis;
    
    if (confidence === 'low' || productIds.length === 0) {
        return {
            message: "Я не смог точно определить вашу проблему. Попробуйте описать симптомы более подробно, например: 'плохо сплю и чувствую усталость' или 'часто болею и нет энергии'.",
            explanation: "На основе вашего запроса сложно определить конкретные проблемы. Вот общие рекомендации для поддержания здоровья:",
            products: Products.getFeatured(3) // Общие рекомендации
        };
    }
    
    const products = productIds
        .map(id => Products.getById(id))
        .filter(Boolean)
        .slice(0, 6); // Максимум 6 рекомендаций
    
    // Группируем ключевые слова по категориям
    const categories = {
        'сон': ['сон', 'спать', 'бессонница', 'пробуждение', 'ночной'],
        'стресс': ['стресс', 'нервы', 'тревож', 'волнение', 'паника', 'напряжение'],
        'энергия': ['усталость', 'энергия', 'силы', 'вялость', 'бодрость'],
        'иммунитет': ['иммунитет', 'простуда', 'грипп', 'вирус', 'болезнь'],
        'пищеварение': ['пищеварение', 'желудок', 'детокс', 'очищение', 'печень'],
        'суставы': ['суставы', 'колени', 'спина', 'артрит', 'хруст'],
        'мозг': ['концентрация', 'память', 'мозг', 'фокус', 'внимание'],
        'настроение': ['настроение', 'депрессия', 'апатия', 'эмоции', 'равновесие']
    };
    
    // Определяем основные категории
    const detectedCategories = [];
    Object.keys(categories).forEach(category => {
        if (keywords.some(keyword => categories[category].some(catWord => keyword.includes(catWord)))) {
            detectedCategories.push(category);
        }
    });
    
    // Создаем объяснение
    let explanation;
    if (detectedCategories.length === 1) {
        const categoryNames = {
            'сон': 'проблемы со сном',
            'стресс': 'стресс и нервное напряжение',
            'энергия': 'усталость и недостаток энергии',
            'иммунитет': 'ослабленный иммунитет',
            'пищеварение': 'проблемы с пищеварением',
            'суставы': 'боли в суставах',
            'мозг': 'снижение концентрации и памяти',
            'настроение': 'эмоциональные проблемы'
        };
        explanation = `Я определил проблему: <strong>${categoryNames[detectedCategories[0]]}</strong>. `;
    } else if (detectedCategories.length > 1) {
        explanation = `Я определил несколько проблем, связанных с: <strong>${detectedCategories.map(cat => {
            const names = {
                'сон': 'сном', 'стресс': 'стрессом', 'энергия': 'энергией',
                'иммунитет': 'иммунитетом', 'пищеварение': 'пищеварением',
                'суставы': 'суставами', 'мозг': 'мозговой деятельностью',
                'настроение': 'настроением'
            };
            return names[cat];
        }).join(', ')}</strong>. `;
    } else {
        explanation = `На основе вашего запроса я определил следующие ключевые слова: <strong>${keywords.slice(0, 3).join(', ')}</strong>. `;
    }
    
    explanation += "Вот рекомендованные БАДы, которые могут помочь:";
    
    // Формируем сообщение
    let message;
    if (detectedCategories.length > 0) {
        const issues = detectedCategories.map(cat => {
            const descriptions = {
                'сон': 'нарушения сна',
                'стресс': 'повышенный стресс',
                'энергия': 'снижение энергии',
                'иммунитет': 'ослабление иммунитета',
                'пищеварение': 'проблемы с пищеварением',
                'суставы': 'дискомфорт в суставах',
                'мозг': 'снижение когнитивных функций',
                'настроение': 'эмоциональный дисбаланс'
            };
            return descriptions[cat];
        });
        
        message = `На основе вашего описания я вижу проблемы с ${issues.join(' и ')}. `;
        message += `Рекомендую следующие БАДы для комплексного решения:`;
    } else {
        message = "Вот рекомендованные БАДы на основе вашего запроса:";
    }
    
    // Добавляем дополнительный совет
    const additionalAdvice = [];
    if (detectedCategories.includes('сон') && detectedCategories.includes('стресс')) {
        additionalAdvice.push("Рекомендую также обратить внимание на режим дня и техники релаксации.");
    }
    if (detectedCategories.includes('энергия') && detectedCategories.includes('иммунитет')) {
        additionalAdvice.push("Для лучшего эффекта сочетайте прием БАДов со сбалансированным питанием.");
    }
    
    if (additionalAdvice.length > 0) {
        message += " " + additionalAdvice.join(" ");
    }
    
    return {
        message: message,
        explanation: explanation,
        products: products,
        keywords: keywords,
        categories: detectedCategories
    };
}

// Функция для получения случайных рекомендаций
function getRandomRecommendations(category, count = 3) {
    const allProducts = Products.getAll();
    const categoryProducts = {
        'сон': [1, 2, 26, 27, 30],
        'стресс': [1, 6, 7, 25, 28, 29],
        'энергия': [3, 8, 9, 10, 24],
        'иммунитет': [4, 11, 12, 13, 21],
        'пищеварение': [5, 17, 18, 22, 23],
        'суставы': [14, 15, 16, 19, 20]
    };
    
    const ids = categoryProducts[category] || [];
    if (ids.length === 0) return Products.getFeatured(count);
    
    // Перемешиваем и берем нужное количество
    const shuffled = [...ids].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, count).map(id => Products.getById(id)).filter(Boolean);
}

// Экспортируем если нужно
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { 
        aiRulesExtended, 
        analyzeHealthRequest, 
        generateAIResponse,
        getRandomRecommendations
    };
} else {
    window.aiRulesExtended = aiRulesExtended;
    window.analyzeHealthRequest = analyzeHealthRequest;
    window.generateAIResponse = generateAIResponse;
    window.getRandomRecommendations = getRandomRecommendations;
}